#!/usr/bin/env bash

echo "=== utils setup ==="

# Function to download and extract zip to Program Files (Windows) or to a folder (Linux)
install_tool() {
    local name=$1
    local url=$2
    local folder=$3
    local exe_name=${4:-$name} # optional different exe name

    if ! command -v "$exe_name" &> /dev/null; then
        echo "Installing $name..."
        tmp_zip="/tmp/${name}.zip"
        curl -L -o "$tmp_zip" "$url"
        mkdir -p "$folder"
        unzip -o "$tmp_zip" -d "$folder"
        rm "$tmp_zip"
        echo "$name installed to $folder"
        echo "Please add '$folder' to your PATH."
    else
        echo "$name is already installed."
    fi
}

# tree on Git Bash / WSL
if ! command -v tree &> /dev/null; then
    echo "Installing tree..."
    if command -v apt &> /dev/null; then
        sudo apt update && sudo apt install -y tree
    else
        echo "Please install tree manually if pacman/apt is not available."
    fi
else
    echo "tree is already installed."
fi

# AWS CLI auto prompt
export AWS_CLI_AUTO_PROMPT=on-partial

# Install Terraform (Windows AMD64 latest stable)
install_tool "terraform" \
    "https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_windows_amd64.zip" \
    "/c/Program Files/Terraform"

# Install jq (Windows AMD64 latest) - direct exe download, rename to jq.exe
if ! command -v jq &> /dev/null; then
    echo "Installing jq..."
    mkdir -p "/c/Program Files/jq"
    curl -L -o "/c/Program Files/jq/jq.exe" \
        "https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
    echo "Please add '/c/Program Files/jq' to your Windows PATH."
else
    echo "jq is already installed."
fi

# Install Node.js (Windows portable LTS)
install_tool "node" \
    "https://nodejs.org/dist/v20.17.0/node-v20.17.0-win-x64.zip" \
    "/c/Program Files/node" \
    "node.exe"

# Install AWS CDK via npm (after Node installed)
if command -v npm &> /dev/null; then
    if ! command -v cdk &> /dev/null; then
        echo "Installing AWS CDK CLI..."
        npm install -g aws-cdk
    else
        echo "AWS CDK CLI is already installed."
    fi
else
    echo "npm not found â€” please check if Node.js was added to your PATH."
fi

# -- Pulumi installation for WSL/Linux --
if ! command -v pulumi &> /dev/null; then
    echo "Installing Pulumi CLI for WSL/Linux..."
    curl -fsSL https://get.pulumi.com | sh
    echo "Pulumi installed! Please restart your shell or run:"
    echo 'export PATH=$PATH:$HOME/.pulumi/bin'
else
    echo "Pulumi CLI is already installed."
fi

# -- CRC32 installation for WSL/Linux --
if grep -qi microsoft /proc/version &>/dev/null; then
    if ! command -v crc32 &> /dev/null; then
        echo "Installing CRC32 tool for WSL..."
        sudo apt update && sudo apt install -y libarchive-zip-perl coreutils
        echo "CRC32 installed. Example usage:"
        echo '  crc32 myfile.txt | xxd -r -p | base64'
    else
        echo "CRC32 is already installed."
    fi
fi

# Change to workspace
cd "/d/AWS Cert Training/AWS Examples/AWS-Examples" || {
    echo "Could not change directory."
    exit 1
}

echo "=== Setup complete ==="

# Notes:
# Terraform:
#   terraform plan
#   terraform apply
#   terraform destroy
#
# AWS CDK:
#   cdk bootstrap aws://<ACCOUNT_ID>/<REGION>
#   cdk deploy
#
# Pulumi:
#   pulumi stack init <stack-name> (if needed)
#   pulumi up
#   pulumi destroy
#
# S3 CRC32 Upload:
#   CRC32_BASE64=$(crc32 myfile.txt | xxd -r -p | base64)
#   aws s3api put-object \
#     --bucket <bucket-name> \
#     --key myfile.txt \
#     --body myfile.txt \
#     --checksum-algorithm CRC32 \
#     --checksum-crc32 "$CRC32_BASE64"
