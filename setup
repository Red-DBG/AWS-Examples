#!/usr/bin/env bash

echo "=== utils setup ==="

# Function to download and extract zip to Program Files
install_tool() {
    local name=$1
    local url=$2
    local folder=$3
    local exe_name=${4:-$name} # optional different exe name

    if ! command -v "$exe_name" &> /dev/null; then
        echo "Installing $name..."
        tmp_zip="/tmp/${name}.zip"
        curl -L -o "$tmp_zip" "$url"
        mkdir -p "$folder"
        unzip -o "$tmp_zip" -d "$folder"
        rm "$tmp_zip"
        echo "$name installed to $folder"
        echo "Please add '$folder' to your Windows PATH (System Environment Variables)."
    else
        echo "$name is already installed."
    fi
}

# tree on Git Bash
if ! command -v tree &> /dev/null; then
    echo "Installing tree..."
    echo "Please install tree manually if pacman is not available."
else
    echo "tree is already installed."
fi

# AWS CLI auto prompt
export AWS_CLI_AUTO_PROMPT=on-partial

# Install Terraform (Windows AMD64 latest stable)
install_tool "terraform" \
    "https://releases.hashicorp.com/terraform/1.9.8/terraform_1.9.8_windows_amd64.zip" \
    "/c/Program Files/Terraform"

# Install jq (Windows AMD64 latest) - direct exe download, rename to jq.exe
if ! command -v jq &> /dev/null; then
    echo "Installing jq..."
    mkdir -p "/c/Program Files/jq"
    curl -L -o "/c/Program Files/jq/jq.exe" \
        "https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
    echo "Please add '/c/Program Files/jq' to your Windows PATH."
else
    echo "jq is already installed."
fi

# Install Node.js (Windows portable LTS)
install_tool "node" \
    "https://nodejs.org/dist/v20.17.0/node-v20.17.0-win-x64.zip" \
    "/c/Program Files/node" \
    "node.exe"

# Install AWS CDK via npm (after Node installed)
if command -v npm &> /dev/null; then
    if ! command -v cdk &> /dev/null; then
        echo "Installing AWS CDK CLI..."
        npm install -g aws-cdk
    else
        echo "AWS CDK CLI is already installed."
    fi
else
    echo "npm not found â€” please check if Node.js was added to your PATH."
fi

# Change to workspace
cd "/d/AWS Cert Training/AWS Examples/AWS-Examples" || {
    echo "Could not change directory."
    exit 1
}

echo "=== Setup complete ==="



# on Terrafrom:
# do the bash: terraform plan
# do the bash: terraform apply
# do the bash: terraform destroy -- to delete

# AWS CDK
# do the cdk bootstrap aws://<ACCOUNT_ID>/<REGION> before deploying the stack i.e. cdk deploy to create S3 Bucket
 